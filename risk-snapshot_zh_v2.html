<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>电路风险快照 | Better Home Technology</title>
  <meta name="description" content="3–4分钟电路风险自测（非检测、非报价）。帮助投资房主判断是否需要进一步做独立评估。" />

  <!-- ✅ 颜色模式：跟随系统（白天浅色，夜间深色） -->
  <style>
    :root{
      --bg: #ffffff;
      --card: #f6f7f9;
      --text: #0f172a;
      --muted: #475569;
      --line: #e2e8f0;
      --primary: #2563eb;
      --primary-2:#1d4ed8;
      --danger:#dc2626;
      --warn:#f59e0b;
      --ok:#16a34a;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 16px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card:#111a2e;
        --text:#e5e7eb;
        --muted:#9ca3af;
        --line:#24314d;
        --primary:#60a5fa;
        --primary-2:#3b82f6;
        --shadow: 0 10px 30px rgba(0,0,0,.35);
      }
    }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;}
    .wrap{max-width:860px;margin:0 auto;padding:24px 16px 56px;}
    header{display:flex;gap:14px;align-items:center;margin:10px 0 18px;}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#22c55e);box-shadow:var(--shadow);}
    h1{font-size:22px;margin:0;}
    .sub{color:var(--muted);font-size:14px;margin-top:2px;}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:13px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;}
    .card h2{font-size:18px;margin:0 0 8px;}
    .card p{margin:8px 0;color:var(--muted);}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;}
    button,.btn{
      border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer;
      background:var(--primary);color:white;box-shadow:0 8px 18px rgba(37,99,235,.22);
      transition:transform .06s ease, background .12s ease;
      text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
    }
    button:hover,.btn:hover{background:var(--primary-2);}
    button:active,.btn:active{transform:translateY(1px);}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--line);box-shadow:none;}
    .btn-ghost:hover{background:rgba(148,163,184,.12);}
    .btn-danger{background:var(--danger);}
    .btn-danger:hover{filter:brightness(.95);}
    .small{font-size:13px;color:var(--muted);margin-top:10px;}
    .step{display:none;}
    .step.active{display:block;}
    .step1-page{display:none;}
    .step1-page.active{display:block;}
    .qtitle{font-size:18px;margin:0 0 10px;}
    .opt{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
    .opt label{
      display:flex;gap:10px;align-items:flex-start;background:rgba(148,163,184,.10);
      border:1px solid var(--line);border-radius:14px;padding:12px 12px;cursor:pointer;
    }
    input[type=radio]{margin-top:3px;}
    .nav{display:flex;justify-content:space-between;gap:10px;margin-top:16px;}
    .note{font-size:12px;color:var(--muted);margin-top:10px;}
    .divider{height:1px;background:var(--line);margin:16px 0;}
    .badge{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:var(--muted);}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);}
    .dot.warn{background:var(--warn);}
    .dot.danger{background:var(--danger);}
    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:50;}
    .overlay.show{display:flex;}
    .modal{
      width:min(760px,100%);
      max-height:min(88vh,720px);
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header,.modal-footer{
      padding:14px 16px;
      background:var(--card);
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-footer{border-top:1px solid var(--line);border-bottom:0;}
    .modal-title{margin:0;font-size:16px;}
    .modal-body{padding:16px;overflow:auto;}
    .x{background:transparent;border:1px solid var(--line);color:var(--text);box-shadow:none;border-radius:10px;padding:8px 10px;}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    .form .full{grid-column:1/-1;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .field label{font-size:13px;color:var(--muted);}
    .field input, .field select, .field textarea{
      padding:12px;border-radius:12px;border:1px solid var(--line);
      background:transparent;color:var(--text);
    }
    .field textarea{min-height:90px;resize:vertical;}
    @media (max-width:720px){
      .form{grid-template-columns:1fr;}
    }
    .success{padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:rgba(34,197,94,.10);color:var(--text);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:var(--muted);}
    .insight{font-size:13px;color:var(--muted);font-style:italic;margin-top:12px;min-height:1.2em;}
    .accordion{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-top:12px;background:rgba(148,163,184,.06);}
    .accordion-toggle{padding:12px 14px;cursor:pointer;font-weight:600;display:flex;justify-content:space-between;}
    .accordion-toggle:hover{background:rgba(148,163,184,.10);}
    .accordion-content{padding:0 14px 12px;font-size:14px;color:var(--muted);display:none;}
    .accordion-content.open{display:block;}
    .step-progress{margin-bottom:12px;font-size:13px;color:var(--muted);}
    .share-btn{padding:10px 20px;background:rgba(255,255,255,0.2);color:white;border:2px solid white;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all .3s ease;}
    .share-btn:hover{background:white;color:#667eea;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2);}
    @keyframes toastSlideIn{from{opacity:0;transform:translateX(100px);}to{opacity:1;transform:translateX(0);}}
    @keyframes toastSlideOut{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(100px);}}
  </style>

  <!-- ✅ GA4：你可以保留同一个 Measurement ID，不需要为中文单独换。
       只要你在微信转发链接里加 UTM（utm_source=wechat...），GA4 就能识别来源。
       如果你已有 GA4 代码，请把下面这段替换成你现有的（保持一致即可）。 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QBYBDVL5FT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QBYBDVL5FT');
  </script>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>电路风险快照</h1>
        <div class="sub">3–4分钟自测（非上门检测｜非报价） · 帮你判断是否需要进一步做独立评估</div>
      </div>
    </header>

    <div class="pill" id="utmPill" style="display:none;"></div>
    <div class="pill" id="stepProgress">Step 0 of 4</div>

    <!-- Step 0: 价值引导页 -->
    <section class="card step active" id="step0">
      <div class="step-progress" id="step0Progress">Step 0 of 4</div>
      <h2>在投入任何维修预算前，先花 3 分钟看清“电气决策清晰度”</h2>
      <p class="sub">这个快照不会告诉您“哪里坏了”，它会帮您诊断更关键的问题：当需要为电气安全做决定时，您是基于清晰的信息，还是模糊的猜测？</p>
      <p class="small">这不是测试您的电气知识，没有对错。完成后，您将获得一份个性化的《电气决策信心评估简报》，并看到下一步建议。</p>
      <div class="accordion" id="faqAccordionZh">
        <div class="accordion-toggle" id="faqToggleZh">我想先了解更多 <span id="faqChevronZh">▼</span></div>
        <div class="accordion-content" id="faqContentZh">
          <p><strong>这会不会推销维修？</strong> 不会。快照只做决策判断，不提供维修报价。</p>
          <p><strong>我需要准备什么？</strong> 不需要。只需按真实情况选择即可。</p>
        </div>
      </div>
      <div class="divider"></div>
      <div class="nav">
        <span></span>
        <button class="btn" id="startBtn0Zh">开始</button>
      </div>
    </section>

    <!-- Step 1: 资格确认（每题一页） -->
    <section class="card step" id="step1">
      <div class="step-progress" id="step1Progress">Step 1 of 4</div>
      <h2>Step 1｜是否适合你？（60秒资格确认）</h2>
      <p class="step1-intro">这个服务更适合“希望减少扯皮、减少误判、希望提前规划”的房东。没有对错，只是确认是否相关。</p>

      <div class="divider"></div>

      <div class="step1-q step1-page active" data-q="0">
        <div class="qtitle">你目前拥有多少套住宅房产？</div>
        <div class="opt">
          <label><input type="radio" name="own" value="0">0 套（我在考虑买入/正在看房）</label>
          <label><input type="radio" name="own" value="1">1 套</label>
          <label><input type="radio" name="own" value="2">2 套</label>
          <label><input type="radio" name="own" value="3">3 套及以上</label>
        </div>
      </div>
      <div class="step1-q step1-page" data-q="1">
        <div class="qtitle">当需要做电气维修/升级决策时，你通常：</div>
        <div class="opt">
          <label><input type="radio" name="decide" value="self">自己处理，愿意研究细节</label>
          <label><input type="radio" name="decide" value="delegate">更倾向交给专业人士/希望有独立建议</label>
        </div>
      </div>
      <div class="step1-q step1-page" data-q="2">
        <div class="qtitle">你更接近哪种状态？</div>
        <div class="opt">
          <label><input type="radio" name="time" value="have">我有时间参与管理细节</label>
          <label><input type="radio" name="time" value="no">我希望尽量少参与，让事情自动运转</label>
        </div>
      </div>
      <div class="step1-q step1-page" data-q="3">
        <div class="qtitle">你是否愿意在做大额电气支出前，先为独立专业判断付费？</div>
        <div class="opt">
          <label><input type="radio" name="pay" value="yes">愿意</label>
          <label><input type="radio" name="pay" value="no">暂时不考虑</label>
        </div>
      </div>

      <div class="nav step1-nav">
        <button class="btn-ghost" id="step1PrevBtn" style="visibility:hidden;">← 上一题</button>
        <button id="step1NextBtn">下一题 →</button>
      </div>
      <div class="note">提示：这不是“问卷”，只是确认你是否属于我们为之设计的那类房东。</div>
    </section>

    <!-- Step 2: Snapshot -->
    <section class="card step" id="step2">
      <div class="step-progress" id="step2Progress">Step 2 of 4</div>
      <h2>Step 2｜电路风险快照（3–4分钟）</h2>
      <p><strong>这不是上门检测</strong>，也<strong>不会产生报价</strong>。它是一份引导式自测，用于判断：你在电气决策上是否存在“信息不充分/信心不足”。</p>
      <div class="divider"></div>

      <div class="qtitle" id="qText">问题加载中…</div>
      <div class="opt" id="qOptions"></div>
      <div class="insight" id="insightBoxZh" aria-live="polite"></div>

      <div class="nav">
        <button class="btn-ghost" id="prevBtn">← 上一题</button>
        <button id="nextBtn">下一题 →</button>
      </div>

      <div class="note">没有对错。你的答案不代表房子一定有问题，只代表“决策是否足够有把握”。</div>
    </section>

    <!-- Step 3: Result -->
    <section class="card step" id="step3">
      <div class="step-progress" id="step3Progress">Step 3 of 4</div>
      <h2>您的《电气决策信心评估简报》已生成</h2>
      <p id="resultText">结果生成中…</p>

      <div class="divider"></div>

      <div class="badge"><span class="dot warn" id="dot"></span><span id="badgeText">提示</span></div>
      <p class="small" id="resultHint"></p>
      <div class="small" style="margin-top:14px;color:var(--muted);">
        <strong>下一步服务能提供：</strong>
        <ul style="margin:10px 0 0 18px;">
          <li>资产电气状况的客观证据（照片与数据）</li>
          <li>未来 1–3 年维修/升级的优先级与预算路线图</li>
          <li>可用于与租客、物业经理或保险公司沟通的专业报告</li>
        </ul>
      </div>

      <div class="btns">
        <button class="btn" id="quickCallBtn">预约 15 分钟电话联系，免费解读快照结果</button>
        <button class="btn btn-ghost" id="learnMoreBtn">了解服务内容</button>
        <a class="btn btn-ghost" id="emailBtn" href="#">邮件联系（自动填好内容）</a>
        <a class="btn btn-ghost" id="pdfDownloadLinkZh" href="investment%20property%20check%20guide%20CN.pdf" download target="_blank" rel="noopener" style="display:none">直接下载《投资房电气风险自查指南》(PDF)</a>
        <button class="btn btn-ghost" id="pdfBtnZh">发送《投资房电气风险自查指南》到邮箱（附感谢说明）</button>
      </div>

      <div class="small">
        <strong>联系邮箱：</strong>
        <a href="mailto:info@bhtechnology.com.au">info@bhtechnology.com.au</a>
      </div>

      <div id="shareSectionZh" class="share-section-zh"></div>

      <div class="divider"></div>

      <div class="small mono" id="debugLine" style="display:none" aria-hidden="true"></div>
    </section>
  </div>

  <!-- Quick Call Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">快速预约电话沟通（我们会按你选择的时间致电）</h3>
        <button class="x" id="closeModalBtn" type="button">关闭</button>
      </div>

      <div class="modal-body">
        <p class="small">填写后点击「提交预约」，我们会收到通知并在你选择的时间段内联系你。</p>

        <div class="form">
          <div class="field">
            <label>姓名</label>
            <input id="name" type="text" placeholder="例如：张先生 / Lisa" />
          </div>
          <div class="field">
            <label>电话</label>
            <input id="phone" type="tel" placeholder="例如：04xx xxx xxx" />
          </div>
          <div class="field">
            <label>邮箱</label>
            <input id="email" type="email" placeholder="例如：name@email.com" />
          </div>
          <div class="field">
            <label>房屋地址（建议填写）</label>
            <input id="address" type="text" placeholder="例如：12 Smith St, Mawson Lakes SA" />
          </div>
          <div class="field">
            <label>你希望我们什么时候联系你？</label>
            <select id="slot">
              <option value="">请选择</option>
              <option>今天 / 1小时内（如可）</option>
              <option>今天 下午（12pm–5pm）</option>
              <option>今天 晚上（5pm–8pm）</option>
              <option>明天 上午（9am–12pm）</option>
              <option>明天 下午（12pm–5pm）</option>
              <option>周末（请在备注说明时间）</option>
            </select>
          </div>
          <div class="field full">
            <label>备注（可选）</label>
            <textarea id="note" placeholder="例如：我主要担心租客反映跳闸；希望先了解是否需要上门评估。"></textarea>
          </div>
        </div>

        <div class="divider"></div>
        <div class="success" id="successBox" style="display:none;">
          已收到！我们的顾问会尽快按你选择的时间联系你。
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" id="emailRequestBtn" type="button">提交预约</button>
        <button class="btn-ghost" id="closeModalBtn2" type="button">取消</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="pdfModalZh" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">发送到邮箱</h3>
        <button class="x" id="closePdfModalZh" type="button">关闭</button>
      </div>
      <div class="modal-body">
        <p class="small" style="margin:0 0 10px">我们会把《投资房电气风险自查指南》和简短感谢说明发到您的邮箱，方便保存或转发。</p>
        <div class="field">
          <label for="pdfEmailZh">邮箱</label>
          <input id="pdfEmailZh" type="email" placeholder="name@email.com" />
        </div>
        <div class="small" id="pdfErrZh" style="color:var(--danger);display:none">请输入有效邮箱</div>
        <div class="btns" style="margin-top:14px">
          <button class="btn" id="pdfSendBtnZh" type="button">发送</button>
          <button class="btn btn-ghost" id="pdfCancelBtnZh" type="button">取消</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- UTM display (helps you verify WeChat campaigns) ----------
  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name) || "";
  }
  const utm_source = getParam("utm_source");
  const utm_medium = getParam("utm_medium");
  const utm_campaign = getParam("utm_campaign");
  const utm = [utm_source, utm_medium, utm_campaign].filter(Boolean).join(" / ");
  document.getElementById("utmPill").textContent = utm ? ("来源标记：" + utm) : "来源：未标记（建议微信链接加 ?utm_source=wechat&utm_medium=social&utm_campaign=pm_cn）";

  // ---------- 推荐来源 ?ref= 检测 ----------
  (function(){
    const referrerID = getParam("ref");
    if(referrerID){
      try{ localStorage.setItem("referredBy", referrerID); } catch(e){}
      if(typeof gtag !== "undefined") gtag("event", "referral_visit", { referrer_id: referrerID });
      const banner = document.createElement("div");
      banner.id = "referralBannerZh";
      banner.innerHTML = '<div style="background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);color:white;padding:12px 20px;text-align:center;font-size:14px;">您是通过朋友推荐来的！完成此检查，您和推荐人各得<strong>$30优惠码</strong>。</div>';
      document.body.insertBefore(banner, document.body.firstChild);
    }
    if(typeof gtag !== "undefined") gtag("event", "page_open", { page: "risk_snapshot_zh", referred_by: localStorage.getItem("referredBy") || "direct" });
  })();

  // ---------- Step 0: 价值引导 ----------
  const INSIGHT_GENERIC_ZH = "提示：如果您在做决定时经常需要“别人给您一个确定答案”，通常意味着缺少可验证的证据与优先级框架。";
  document.getElementById("startBtn0Zh").addEventListener("click", ()=>{ showStep(1); });
  document.getElementById("faqToggleZh").addEventListener("click", ()=>{
    const c = document.getElementById("faqContentZh"); const t = document.getElementById("faqToggleZh");
    if(c && t){ c.classList.toggle("open"); t.setAttribute("aria-expanded", c.classList.contains("open")); }
  });

  // ---------- Flow control ----------
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const step3 = document.getElementById("step3");

  const step0 = document.getElementById("step0");
  function showStep(n){
    [step0,step1,step2,step3].forEach(el=>{ if(el) el.classList.remove("active"); });
    if(n===0 && step0) step0.classList.add("active");
    if(n===1 && step1) step1.classList.add("active");
    if(n===2 && step2) step2.classList.add("active");
    if(n===3 && step3) step3.classList.add("active");
    const pill = document.getElementById("stepProgress");
    if(pill) pill.textContent = "Step " + n + " of 4";
    window.scrollTo({top:0,behavior:"smooth"});
  }

  // ---------- Step 1: 每题一页 + Fit check ----------
  const step1Pages = document.querySelectorAll(".step1-page");
  const step1Intro = document.querySelector(".step1-intro");
  let step1Idx = 0;

  function showStep1Page(n){
    step1Idx = n;
    step1Pages.forEach((el,i)=>{ el.classList.toggle("active", i === n); });
    step1Intro.style.display = (n === 0) ? "block" : "none";
    document.getElementById("step1PrevBtn").style.visibility = (n === 0) ? "hidden" : "visible";
    document.getElementById("step1NextBtn").textContent = (n === step1Pages.length - 1) ? "→ 继续：开始风险快照（3–4分钟）" : "下一题 →";
    window.scrollTo({top:0,behavior:"smooth"});
  }

  document.getElementById("step1PrevBtn").addEventListener("click", ()=>{
    if(step1Idx > 0) showStep1Page(step1Idx - 1);
  });

  document.getElementById("step1NextBtn").addEventListener("click", ()=>{
    const names = ["own","decide","time","pay"];
    const currentName = names[step1Idx];
    const checked = document.querySelector(`input[name=${currentName}]:checked`);
    if(!checked){
      alert("请先选择一个选项。");
      return;
    }
    if(step1Idx < step1Pages.length - 1){
      showStep1Page(step1Idx + 1);
    }else{
      // 最后一题：做 fit check 并进入 Step 2
      const pay = document.querySelector("input[name=pay]:checked")?.value || "";
      if(pay === "no"){
        if(!confirm("没关系，你仍然可以继续做风险快照（免费）。\n如果你之后需要更深入的独立评估，我们再讨论。现在继续吗？")){
          return;
        }
      }
      showStep(2);
      renderQuestion();
    }
  });

  // ---------- Snapshot questions (6 cards) + 即时洞察映射 ----------
  const INSIGHT_MAP_ZH = {
    0: { 0: "“真的有必要吗？”这种事后怀疑，往往说明做决定时缺少清晰标准。", 1: "不确定该不该做，通常是因为缺少可依据的证据与优先级。", 2: "有把握是好事；简报可以帮你把判断依据固化下来。" },
    1: { 0: "意见不一很常见；快照关注的是你的决策过程，而不是谁“对”。", 1: "知道怎么选已经是一半；简报可以为以后留下依据。", 2: "没有遇到过不同意见，也不代表没有决策盲区，快照会帮你检查。" },
    2: { 0: "曾经的担心是一个信号；快照有助于把模糊感受变成清晰图景。", 1: "没有担心过是好的背景；快照仍会检查当前的决策清晰度。" },
    3: { 0: "全局认知清晰是优势；简报可以帮你把现状记录下来。", 1: "“一般”往往意味着有缺口；快照会标出可能的不确定点。", 2: INSIGHT_GENERIC_ZH },
    4: { 0: INSIGHT_GENERIC_ZH, 1: "愿意必要时参与，配合清晰的优先级清单会更高效；评估可以提供这份清单。" },
    5: { 0: "反应式没问题；快照仍能显示哪里多一点规划会减少压力。", 1: "提前规划配合书面证据更稳；下一步服务可以支持这一点。" }
  };
  const questions = [
    {
      text: "当有人建议做电方面的工作时，你通常会：",
      options: [
        "我会很快同意，但事后会想：真的有必要吗？",
        "我会拖一拖，因为我不确定该不该做",
        "我通常很有把握，知道该怎么判断"
      ]
    },
    {
      text: "你是否遇到过：同一个问题，不同电工给出不同意见或不同报价？",
      options: [
        "有，而且让我更难做决定",
        "有，但我大概知道该怎么选",
        "没有"
      ]
    },
    {
      text: "电工工作做完以后，你是否曾担心过安全或质量？",
      options: [
        "有过",
        "没有"
      ]
    },
    {
      text: "你是否对这套房的整体电路状况有一个清晰的“全局认知”？",
      options: [
        "很清楚",
        "一般",
        "不太清楚"
      ]
    },
    {
      text: "你希望自己花多少时间来处理电相关的事情？",
      options: [
        "越少越好（能交给别人就交给别人）",
        "我不介意必要时参与"
      ]
    },
    {
      text: "你更接近哪种偏好？",
      options: [
        "出问题再处理（反应式）",
        "希望提前规划，即使现在没紧急问题（计划式）"
      ]
    }
  ];

  let idx = 0;
  const answers = new Array(questions.length).fill(null);

  const qText = document.getElementById("qText");
  const qOptions = document.getElementById("qOptions");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const insightBoxZh = document.getElementById("insightBoxZh");
  function updateInsightZh(optIndex){
    const map = INSIGHT_MAP_ZH[idx];
    const text = (map && map[optIndex] !== undefined) ? map[optIndex] : INSIGHT_GENERIC_ZH;
    if(insightBoxZh) insightBoxZh.textContent = text ? "\u200B" + text : "";
  }

  function renderQuestion(){
    const q = questions[idx];
    qText.textContent = q.text;
    qOptions.innerHTML = "";
    q.options.forEach((opt, i)=>{
      const id = `q${idx}_${i}`;
      const label = document.createElement("label");
      label.innerHTML = `<input type="radio" name="q${idx}" value="${i}" id="${id}"> ${opt}`;
      const radio = label.querySelector("input");
      radio.addEventListener("change", ()=>{ updateInsightZh(i); });
      qOptions.appendChild(label);
      if(answers[idx] === i){
        radio.checked = true;
        updateInsightZh(i);
      }
    });

    if(insightBoxZh && answers[idx] === null) insightBoxZh.textContent = "";
    prevBtn.disabled = (idx===0);
    nextBtn.textContent = (idx===questions.length-1) ? "完成 →" : "下一题 →";
  }

  prevBtn.addEventListener("click", ()=>{
    if(idx>0){ idx--; renderQuestion(); }
  });

  nextBtn.addEventListener("click", ()=>{
    const picked = document.querySelector(`input[name=q${idx}]:checked`);
    if(!picked){
      alert("请选择一个选项。");
      return;
    }
    answers[idx] = parseInt(picked.value,10);

    if(idx < questions.length-1){
      idx++; renderQuestion();
    }else{
      showResult();
    }
  });

  // ---------- Result logic ----------
  function score(){
    // higher score = more uncertainty
    let s = 0;
    // Q1: option 0/1 indicate uncertainty
    if(answers[0] === 0) s += 2;
    if(answers[0] === 1) s += 2;
    if(answers[0] === 2) s += 0;

    // Q2
    if(answers[1] === 0) s += 2;
    if(answers[1] === 1) s += 1;
    if(answers[1] === 2) s += 0;

    // Q3
    if(answers[2] === 0) s += 2;
    if(answers[2] === 1) s += 0;

    // Q4
    if(answers[3] === 0) s += 0;
    if(answers[3] === 1) s += 1;
    if(answers[3] === 2) s += 2;

    // Q5
    if(answers[4] === 0) s += 1;
    if(answers[4] === 1) s += 0;

    // Q6
    if(answers[5] === 0) s += 1;
    if(answers[5] === 1) s += 0;

    return s; // 0-10-ish
  }

  function getRiskLevelZh(){
    const s = score();
    if(s <= 2) return "green";
    if(s <= 6) return "yellow";
    return "red";
  }

  function generateReferralIDZh(){
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const name = (nameEl && nameEl.value) ? nameEl.value.trim() : "";
    const phone = (phoneEl && phoneEl.value) ? phoneEl.value.trim() : "";
    if(name && phone){
      const initial = name.charAt(0).toUpperCase();
      const last4 = phone.replace(/\D/g, "").slice(-4) || "0000";
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return initial + last4 + random;
    }
    return "REF" + Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  function getReferralLinkZh(){
    const rid = generateReferralIDZh();
    return window.location.origin + window.location.pathname + "?ref=" + rid;
  }

  function showToastZh(msg){
    const existing = document.querySelector(".referral-toast-zh");
    if(existing) existing.remove();
    const toast = document.createElement("div");
    toast.className = "referral-toast-zh";
    toast.textContent = msg;
    toast.style.cssText = "position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:99999;animation:toastSlideIn .3s ease;";
    document.body.appendChild(toast);
    setTimeout(function(){
      toast.style.animation = "toastSlideOut .3s ease forwards";
      setTimeout(function(){ toast.remove(); }, 300);
    }, 3000);
  }

  function copyReferralLinkZh(){
    const input = document.getElementById("referralLinkInputZh");
    if(!input) return;
    input.select();
    input.setSelectionRange(0, 99999);
    try{ navigator.clipboard.writeText(input.value); }
    catch(e){ document.execCommand("copy"); }
    showToastZh("链接已复制！分享给朋友吧");
    if(typeof gtag !== "undefined") gtag("event", "referral_link_copied", { user_id: (input.value.split("ref=")[1] || "").split("&")[0] || "", risk_level: getRiskLevelZh() });
  }

  function shareViaEmailZh(){
    const input = document.getElementById("referralLinkInputZh");
    const link = input ? input.value : getReferralLinkZh();
    const subject = encodeURIComponent("免费投资房电气风险自测");
    const body = encodeURIComponent("你好，\n\n我用了 Better Home 的免费电气风险快照工具，3分钟就能知道投资房有没有风险。\n\n你也试试：" + link + "\n\n完成检查还能各得$30优惠码~\n\nCheers");
    window.open("mailto:?subject=" + subject + "&body=" + body);
    if(typeof gtag !== "undefined") gtag("event", "share_button_clicked", { platform: "email", user_id: generateReferralIDZh() });
  }

  function shareViaWhatsAppZh(){
    const input = document.getElementById("referralLinkInputZh");
    const link = input ? input.value : getReferralLinkZh();
    const text = encodeURIComponent("刚做了投资房免费电气安全检查，发现有些问题！\n\n你也检查一下（3分钟）：" + link + "\n\n完成还能各得$30优惠~");
    window.open("https://wa.me/?text=" + text);
    if(typeof gtag !== "undefined") gtag("event", "share_button_clicked", { platform: "whatsapp", user_id: generateReferralIDZh() });
  }

  function shareViaFacebookZh(){
    const input = document.getElementById("referralLinkInputZh");
    const link = input ? input.value : getReferralLinkZh();
    window.open("https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(link));
    if(typeof gtag !== "undefined") gtag("event", "share_button_clicked", { platform: "facebook", user_id: generateReferralIDZh() });
  }

  function shareViaWeChatZh(){
    const input = document.getElementById("referralLinkInputZh");
    const link = input ? input.value : getReferralLinkZh();
    const wechatText = "刚用了Better Home的免费电气安全检查工具，3分钟就知道我家投资房哪里有风险！\n\n你也试试：" + link + "\n\n完成检查还能各得$30优惠码~";
    try{ navigator.clipboard.writeText(wechatText); }
    catch(e){ document.execCommand("copy"); }
    showToastZh("文案已复制！打开微信粘贴发送给朋友");
    if(typeof gtag !== "undefined") gtag("event", "share_button_clicked", { platform: "wechat", user_id: generateReferralIDZh() });
  }

  function renderShareSectionZh(){
    const level = getRiskLevelZh();
    const link = getReferralLinkZh();
    const shareLinkHtml = '<div style="background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:12px;padding:15px;margin-bottom:20px;"><p style="color:white;font-size:14px;margin:0 0 8px 0;">您的推荐链接：</p><div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;"><input type="text" id="referralLinkInputZh" value="' + link + '" readonly style="flex:1;min-width:180px;padding:10px;border-radius:8px;border:none;font-size:14px;" /><button onclick="copyReferralLinkZh()" style="padding:10px 20px;background:white;color:#667eea;border:none;border-radius:8px;cursor:pointer;font-weight:600;">复制</button></div></div>';
    const shareBtns = '<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;"><button onclick="shareViaEmailZh()" class="share-btn">邮件分享</button><button onclick="shareViaWhatsAppZh()" class="share-btn">WhatsApp</button><button onclick="shareViaFacebookZh()" class="share-btn">Facebook</button><button onclick="shareViaWeChatZh()" class="share-btn">微信</button></div>';
    if(level === "green"){
      return '<div style="margin-top:30px;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:16px;text-align:center;"><h3 style="color:white;margin:0 0 10px 0;">分享此快照</h3><p style="color:rgba(255,255,255,0.9);margin:0 0 20px 0;">你可以分享给其他房东做参考。</p>' + shareLinkHtml + shareBtns + '<p style="color:rgba(255,255,255,0.8);font-size:13px;margin:15px 0 0 0;">朋友完成快照后，我们会发送感谢优惠码（以邮件形式）。</p></div>';
    }
    if(level === "yellow"){
      return '<div style="margin-top:30px;padding:20px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border-radius:16px;text-align:center;"><h3 style="color:white;margin:0 0 10px 0;">分享此快照</h3><p style="color:rgba(255,255,255,0.9);margin:0 0 20px 0;">你可以分享给其他房东做参考。</p>' + shareLinkHtml + shareBtns + '<p style="color:rgba(255,255,255,0.8);font-size:13px;margin:15px 0 0 0;">朋友完成快照后，我们会发送感谢优惠码（以邮件形式）。</p></div>';
    }
    return '<div style="margin-top:30px;padding:20px;background:linear-gradient(135deg,#ff0844 0%,#ffb199 100%);border-radius:16px;text-align:center;box-shadow:0 0 30px rgba(255,8,68,0.3);"><h3 style="color:white;margin:0 0 10px 0;">分享此快照</h3><p style="color:rgba(255,255,255,0.9);margin:0 0 20px 0;">你可以分享给其他房东做参考。</p>' + shareLinkHtml + shareBtns + '<p style="color:rgba(255,255,255,0.8);font-size:13px;margin:15px 0 0 0;">朋友完成快照后，我们会发送感谢优惠码（以邮件形式）。</p></div>';
  }

  function showResult(){
    const s = score();
    const resultText = document.getElementById("resultText");
    const dot = document.getElementById("dot");
    const badgeText = document.getElementById("badgeText");
    const hint = document.getElementById("resultHint");
    const debug = document.getElementById("debugLine");

    if(s <= 2){
      dot.className = "dot";
      badgeText.textContent = "决策不确定性较低";
      resultText.innerHTML = "从你的回答来看，你在电气相关决策上通常比较有把握。";
      hint.textContent = "这不代表房屋「完全没有风险」，只是说明你目前的决策较少受不确定性影响。若你希望把未来 1–5 年可能的电气支出更系统地规划，可以了解独立评估。";
    }else if(s <= 6){
      dot.className = "dot warn";
      badgeText.textContent = "存在一定不确定性";
      resultText.innerHTML = "从你的回答来看，你在部分电气决策上可能存在信息不足或信心不足的情况。";
      hint.textContent = "这不代表房子一定有问题。它只是提示：未来遇到电气支出或租客投诉时，你可能更需要清晰的证据与优先级框架。独立评估可以帮助你把这些决策变得更清晰。";
    }else{
      dot.className = "dot danger";
      badgeText.textContent = "不确定性较高，建议进一步确认";
      resultText.innerHTML = "从你的回答来看，你目前在电气决策上可能经常处于不确定、犹豫或需要额外依据的状态。";
      hint.textContent = "这不代表已确认存在安全故障。它提示：当决策在压力下发生时（例如租客投诉、跳闸、紧急维修），更容易出现过度支出或责任风险。独立评估的目的，是在问题升级前为你提供可依据的判断与规划路径。";
    }

    // 内部记录不向用户展示
    // debug.textContent = `（内部记录）score=${s} | utm=${utm || "none"}`;

    // Update mailto link with prefilled content
    updateMailto();

    // 渲染推荐分享区域
    const shareEl = document.getElementById("shareSectionZh");
    if(shareEl) shareEl.innerHTML = renderShareSectionZh();

    // 推荐链接随姓名/电话更新
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    function updRef(){ const inp = document.getElementById("referralLinkInputZh"); if(inp){ const rid = generateReferralIDZh(); inp.value = window.location.origin + window.location.pathname + "?ref=" + rid; } }
    if(nameEl) nameEl.addEventListener("input", updRef);
    if(phoneEl) phoneEl.addEventListener("input", updRef);

    if(typeof gtag !== "undefined") gtag("event", "snapshot_completed", { risk_level: getRiskLevelZh(), referred_by: localStorage.getItem("referredBy") || "direct" });

    showStep(3);
  }

  // ---------- Buttons on result page ----------
  document.getElementById("learnMoreBtn").addEventListener("click", ()=>{
    alert("我们可以把独立评估理解为：\n\n① 现场数据采集（非破坏）\n② 风险优先级：哪些要马上关注、哪些可以计划、哪些可以忽略\n③ 未来 1–5 年预算参考（CapEx 规划范围）\n④ 给房东/中介一个可引用的第三方判断依据\n\n如果你希望进一步了解，建议点击“快速预约电话沟通”。");
  });

  const overlay = document.getElementById("overlay");
  function openModal(){ overlay.classList.add("show"); overlay.setAttribute("aria-hidden","false"); }
  function closeModal(){ overlay.classList.remove("show"); overlay.setAttribute("aria-hidden","true"); }
  document.getElementById("quickCallBtn").addEventListener("click", openModal);
  document.getElementById("closeModalBtn").addEventListener("click", closeModal);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });

  function openPdfModalZh(){
    const m = document.getElementById("pdfModalZh");
    if(!m) return;
    m.classList.add("show");
    m.style.display = "flex";
    m.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    const inp = document.getElementById("pdfEmailZh");
    if(inp){ inp.value = ""; inp.focus(); }
    const err = document.getElementById("pdfErrZh");
    if(err) err.style.display = "none";
  }
  function closePdfModalZh(){
    const m = document.getElementById("pdfModalZh");
    if(!m) return;
    m.classList.remove("show");
    m.style.display = "none";
    m.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }
  document.getElementById("pdfBtnZh").addEventListener("click", openPdfModalZh);
  document.getElementById("closePdfModalZh").addEventListener("click", closePdfModalZh);
  document.getElementById("pdfCancelBtnZh").addEventListener("click", closePdfModalZh);
  document.getElementById("pdfModalZh").addEventListener("click", (e)=>{ if(e.target.id === "pdfModalZh") closePdfModalZh(); });
  document.getElementById("pdfSendBtnZh").addEventListener("click", async ()=>{
    const inp = document.getElementById("pdfEmailZh");
    const err = document.getElementById("pdfErrZh");
    const email = inp && inp.value ? inp.value.trim() : "";
    const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    if(!ok){ if(err) err.style.display = "block"; err.textContent = "请输入有效邮箱"; return; }
    if(err) err.style.display = "none";
    const btn = document.getElementById("pdfSendBtnZh");
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "发送中…";
    try {
      const res = await fetch("/.netlify/functions/send-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, lang: "zh" }),
      });
      const data = await res.json().catch(() => ({}));
      closePdfModalZh();
      if(res.ok && data.ok){
        alert("已发送到您的邮箱，请查收。感谢您完成快照。");
      } else {
        var link = document.getElementById("pdfDownloadLinkZh"); if(link) link.style.display = "inline-flex";
        alert(data.error || "发送失败，请使用下方「直接下载」链接获取。");
      }
    } catch (e) {
      var link = document.getElementById("pdfDownloadLinkZh"); if(link) link.style.display = "inline-flex";
      alert("网络异常，请使用下方「直接下载」链接获取。");
    }
    btn.disabled = false;
    btn.textContent = origText;
  });

  // ---------- Submit quick call (send via API, no mailto) ----------
  document.getElementById("emailRequestBtn").addEventListener("click", async ()=>{
    const name = document.getElementById("name")?.value || "";
    const phone = document.getElementById("phone")?.value || "";
    const email = document.getElementById("email")?.value || "";
    const address = document.getElementById("address")?.value || "";
    const slot = document.getElementById("slot")?.value || "";
    const note = document.getElementById("note")?.value || "";
    
    if(!name || !phone || !email){
      alert("请先填写姓名、电话和邮箱。");
      return;
    }
    
    const btn = document.getElementById("emailRequestBtn");
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "提交中…";
    try {
      const res = await fetch("/.netlify/functions/send-booking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "quickcall",
          lang: "zh",
          name, phone, email, address, slot, note,
          summary: buildAnswerSummaryZh(),
          utm: utm || "",
          page: window.location.href,
          referredBy: localStorage.getItem("referredBy") || "direct",
        }),
      });
      const data = await res.json().catch(() => ({}));
      if(res.ok && data.ok){
        document.getElementById("successBox").style.display = "block";
        btn.style.display = "none";
      } else {
        alert(data.error || "提交失败，请稍后重试或直接致电/邮件联系我们。");
      }
    } catch (e) {
      alert("网络异常，请稍后重试或直接联系我们。");
    }
    btn.disabled = false;
    btn.textContent = origText;
  });
  
  // Close modal button in footer
  const closeModalBtn2 = document.getElementById("closeModalBtn2");
  if(closeModalBtn2) closeModalBtn2.addEventListener("click", closeModal);

  // ---------- Email requests ----------
  function encode(s){ return encodeURIComponent(s); }

  function buildAnswerSummaryZh(){
    const lines = [];
    const own = document.querySelector("input[name=own]:checked");
    const decide = document.querySelector("input[name=decide]:checked");
    const time = document.querySelector("input[name=time]:checked");
    const pay = document.querySelector("input[name=pay]:checked");
    if(own) lines.push("房产数量：" + (own.value === "0" ? "0 套（考虑买入/看房）" : own.value === "1" ? "1 套" : own.value === "2" ? "2 套" : "3 套及以上"));
    if(decide) lines.push("电气决策方式：" + (decide.value === "self" ? "自己处理，愿意研究细节" : "更倾向交给专业人士/希望有独立建议"));
    if(time) lines.push("时间状态：" + (time.value === "have" ? "有时间参与管理细节" : "希望尽量少参与"));
    if(pay) lines.push("是否愿为独立判断付费：" + (pay.value === "yes" ? "愿意" : "暂时不考虑"));
    questions.forEach((q, i)=>{
      if(answers[i] !== null && q.options[answers[i]] !== undefined)
        lines.push(`快照 Q${i+1} ${q.text} → ${q.options[answers[i]]}`);
    });
    return lines.join("\n");
  }

  function buildEmailBody(includeForm=false){
    const name = document.getElementById("name")?.value || "";
    const phone = document.getElementById("phone")?.value || "";
    const email = document.getElementById("email")?.value || "";
    const address = document.getElementById("address")?.value || "";
    const slot = document.getElementById("slot")?.value || "";
    const note = document.getElementById("note")?.value || "";
    const page = window.location.href;

    let body = "";
    body += "您好，BH Technology 团队：\n\n";
    body += "我刚完成【电路风险快照】，希望了解是否需要进一步做独立评估。\n\n";
    body += "【联系方式】\n";
    if(name) body += `姓名：${name}\n`;
    if(phone) body += `电话：${phone}\n`;
    if(email) body += `邮箱：${email}\n`;
    if(address) body += `地址：${address}\n`;
    if(includeForm){
      if(slot) body += `期望通话时间：${slot}\n`;
      if(note) body += `备注：${note}\n`;
    }
    body += "\n【快照选择结果】\n";
    body += buildAnswerSummaryZh();
    body += "\n\n【我的来源】\n";
    body += `utm_source/medium/campaign：${utm || "未标记"}\n`;
    body += `页面链接：${page}\n\n`;

    body += "谢谢！\n";
    body += "（提示：点击发送邮件后，如果你没有收到自动回复，我们也会在工作时间尽快联系你。）\n";
    return body;
  }

  function updateMailto(includeForm=false){
    const subject = "Request: Independent Electrical Risk Assessment / Callback";
    const body = buildEmailBody(includeForm);

    const mailto = `mailto:info@bhtechnology.com.au?subject=${encode(subject)}&body=${encode(body)}`;
    document.getElementById("emailBtn").setAttribute("href", mailto);
    document.getElementById("emailRequestBtn").setAttribute("href", mailto);
  }

  // emailRequestBtn click handler moved to "Submit quick call" section above

  // Also update when user types
  ["name","phone","email","address","slot","note"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", ()=>updateMailto(true));
    if(el) el.addEventListener("change", ()=>updateMailto(true));
  });
</script>
</body>
</html>
