<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eligibility Check & Electrical Risk Snapshot</title>
  
  <!-- Google Analytics 4 (GA4) -->
  <!-- 
    IMPORTANT: Replace GA_MEASUREMENT_ID with your actual GA4 Measurement ID (e.g., G-XXXXXXX)
    You need to replace it in TWO places:
    1. In the script src URL below: id=G-QBYBDVL5FT
    2. In the gtag('config', 'G-QBYBDVL5FT') call below
    3. In the JavaScript constant GA_MEASUREMENT_ID in the script section
  -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QBYBDVL5FT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QBYBDVL5FT');
  </script>
  
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --text:#e9ecf1;
      --muted:#a9b0bd;
      --border:#232735;
      --accent:#6ea8fe;
      --danger:#ff6b6b;
      --ok:#51cf66;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 700px at 20% 0%, #14182a 0%, var(--bg) 55%);
      color:var(--text);
      line-height:1.55;
      font-size: 18px;
    }
    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 28px 16px 60px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    .brand h1{font-size:22px; margin:0; letter-spacing:.2px;}
    .brand p{margin:0; color:var(--muted); font-size:15px;}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:10px 14px;
      border-radius:999px;
      font-size:14px;
      color:var(--muted);
      white-space:nowrap;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .steps{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px;}
    .stepTag{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:14px;
    }
    .stepTag.active{
      border-color: rgba(110,168,254,.55);
      color: var(--text);
      background: rgba(110,168,254,.10);
    }
    .hr{height:1px; background:var(--border); margin:18px 0;}
    h2{margin:0 0 10px; font-size:26px;}
    h3{margin:0 0 8px; font-size:19px;}
    .sub{margin:0 0 16px; color:var(--muted); font-size:16px;}
    .qTitle{font-size:20px; margin:0 0 14px;}
    .choices{display:grid; gap:12px; margin: 14px 0 20px;}
    label.choice{
      display:flex; gap:12px; align-items:flex-start;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      font-size: 17px;
    }
    label.choice:hover{
      transform: translateY(-1px);
      border-color: rgba(110,168,254,.45);
      background: rgba(110,168,254,.06);
    }
    input[type="radio"]{margin-top:4px; accent-color: var(--accent); min-width:20px; min-height:20px;}
    .hint{font-size:15px; color:var(--muted); margin-top:6px;}
    .nav{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      margin-top: 10px;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 17px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    button:hover{
      transform: translateY(-1px);
      border-color: rgba(110,168,254,.55);
      background: rgba(110,168,254,.10);
    }
    button:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .primary{
      border-color: rgba(110,168,254,.55);
      background: rgba(110,168,254,.15);
    }
    .primary:hover{background: rgba(110,168,254,.22);}
    .ghost{background: transparent;}
    .resultBox{
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px;
      background: rgba(255,255,255,.02);
      margin-top: 14px;
      font-size: 17px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:14px;
      color: var(--muted);
      margin-bottom:10px;
    }
    .badge.ok{border-color: rgba(81,207,102,.45); background: rgba(81,207,102,.10); color: var(--text);}
    .badge.no{border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.10); color: var(--text);}
    .small{font-size:15px; color:var(--muted);}
    .ctaRow{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px;}
    a.cta, button.cta{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 17px;
      min-height: 48px;
    }
    a.cta:hover, button.cta:hover{
      border-color: rgba(110,168,254,.55);
      background: rgba(110,168,254,.12);
      transform: translateY(-1px);
    }
    .footerNote{margin-top:18px; font-size:15px; color:var(--muted);}
    .insight{font-size:15px;color:var(--muted);font-style:italic;margin-top:14px;min-height:1.2em;}
    .accordion{border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:14px;background:rgba(255,255,255,.02);}
    .accordion-toggle{padding:14px 16px;cursor:pointer;font-weight:600;font-size:17px;display:flex;justify-content:space-between;align-items:center;}
    .accordion-toggle:hover{background:rgba(110,168,254,.06);}
    .accordion-content{padding:0 16px 14px;font-size:16px;color:var(--muted);display:none;}
    .accordion-content.open{display:block;}
    .progress{
      height: 8px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(110,168,254,.85), rgba(110,168,254,.35));
      transition: width .18s ease;
    }
    .topRow{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 15px;
    }
    input[type="text"], input[type="tel"], input[type="email"], textarea{
      width:100%;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size: 17px;
    }
    textarea{resize: vertical;}
    .err{display:none; color: var(--danger); font-size:15px; margin-top:8px;}
    @media (max-width: 520px){
      body{ font-size: 17px; }
      .card{padding:18px; border-radius:16px;}
      h2{font-size:22px;}
      .qTitle{font-size:18px;}
    }
  
    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      overflow-y: auto;
      overscroll-behavior: contain;
      z-index:9999;
    }
    .modalOverlay.open{display:flex;}
    .modal{
      width:min(820px, 100%);
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(17,19,26,.98);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding:18px 18px 14px;
      max-height: calc(100vh - 40px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .modalTop h3{margin:0; font-size:20px;}
    .modalClose{
      border:1px solid var(--border);
      background: transparent;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      color: var(--muted);
    }
    .modalClose:hover{border-color: rgba(110,168,254,.55); color: var(--text);}
    .scriptGrid{
      display:grid;
      gap:12px;
      margin-top:10px;
    }
    .scriptCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
    }
    .scriptCard .k{font-size:14px; color:var(--muted); margin-bottom:6px;}
    .scriptCard .v{font-size:16px; color:var(--text);}
    .miniPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:14px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

  
    /* Auto theme: follow browser setting */
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#111827;
        --muted:#4b5563;
        --border:#e5e7eb;
        --accent:#2563eb;
        --danger:#b91c1c;
        --ok:#15803d;
      }
      body{
        background: radial-gradient(1000px 700px at 20% 0%, #ffffff 0%, var(--bg) 60%);
      }
      .card{
        box-shadow: 0 18px 45px rgba(17,24,39,.10);
        background: rgba(0,0,0,.0);
      }
      label.choice{ background: rgba(0,0,0,.02); }
      .modal{
        background: rgba(255,255,255,.98);
        box-shadow: 0 30px 80px rgba(17,24,39,.18);
      }
      .modalOverlay{ background: rgba(17,24,39,.35); }
    }

    .share-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .share-btn:hover {
      background: white;
      color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    @keyframes toastSlideIn {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toastSlideOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100px); }
    }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Eligibility Check & Electrical Risk Snapshot</h1>
        <p>One question per page • Fast, no technical knowledge required</p>
      </div>
      <div class="pill" id="statusPill">Step 0 of 5</div>
    </header>

    <div class="card">
      <div class="steps">
        <div class="stepTag active" id="tag0">Step 0 — Value</div>
        <div class="stepTag" id="tag1">Step 1 — Is this right for you?</div>
        <div class="stepTag" id="tag2">Step 2 — Electrical Risk Snapshot</div>
        <div class="stepTag" id="tag3">Step 3 — Result & next step</div>
        <div class="stepTag" id="tag4">Step 4 — Contact details</div>
      </div>

      <div class="progress" aria-label="progress">
        <div class="bar" id="bar"></div>
      </div>
      <div class="topRow">
        <div id="progressText">0% complete</div>
        <div id="timeText">~5 minutes total</div>
      </div>

      <div class="hr"></div>

      <main id="app"></main>

      <div class="footerNote">
        <div><strong>Note:</strong> This is not an inspection and does not result in a quote.</div>
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Configuration / Content
  // -----------------------------

  // TODO: Replace GA_MEASUREMENT_ID with your actual GA4 Measurement ID (e.g., G-XXXXXXX)
  // This ID should match the one in the <head> gtag script above
  const GA_MEASUREMENT_ID = "G-QBYBDVL5FT";

  // Replace this with your real "Learn more" page URL on your website later.
  // Example: "/independent-assessment"
  const LEARN_MORE_URL = "#";

  const CONTACT_EMAIL = "info@bhtechnology.com.au";

  const ELIGIBILITY = [
    {
      id: "elig_q1",
      title: "How many residential properties do you currently own?",
      options: ["0", "1", "2", "3+"]
    },
    {
      id: "elig_q2",
      title: "When technical maintenance decisions are needed, you usually:",
      options: ["Handle them yourself", "Prefer to delegate or rely on independent advice"]
    },
    {
      id: "elig_q3",
      title: "Which best describes your availability?",
      options: ["I have time to manage details", "I prefer things to run without my involvement"]
    },
    {
      id: "elig_q4",
      title: "Are you open to paying for independent professional advice before committing to major electrical work?",
      options: ["Yes", "No"]
    }
  ];

  const INSIGHT_GENERIC_EN = "Tip: If you often need someone to \"tell you the answer\", it usually means you're missing verifiable evidence and a prioritised framework.";
  const INSIGHT_MAP_EN = {
    elig_q1: { 0: "Many owners start here — the snapshot helps clarify what to do before you buy.", 1: "One property often means every decision matters more; clarity pays off.", 2: "With multiple properties, a consistent framework saves time and reduces risk.", 3: "With multiple properties, a consistent framework saves time and reduces risk." },
    elig_q2: { 0: "Handling things yourself works best when you have clear evidence to base decisions on.", 1: INSIGHT_GENERIC_EN },
    elig_q3: { 0: "Having time is useful; the snapshot can still surface where clarity is missing.", 1: INSIGHT_GENERIC_EN },
    elig_q4: { 0: "Paying for independent advice often reduces costly mistakes later.", 1: "You can still complete the snapshot — it may help you decide if advice is worth it later." },
    snap_1: { 0: "That \"did I do the right thing?\" feeling often means decisions were made without clear criteria.", 1: "Uncertainty usually points to missing information, not a character flaw.", 2: "Confidence often comes from having a clear framework — the brief can reinforce or extend yours." },
    snap_2: { 0: "Different opinions are common; the snapshot focuses on your decision process, not who's \"right\".", 1: "Knowing how to choose is half the battle; the brief can document that for future decisions.", 2: "Lack of conflicting advice can still hide uncertainty — the snapshot checks both." },
    snap_3: { 0: "Past worry is a signal; the snapshot helps turn that into a clearer picture.", 1: "No past worry is useful context; the snapshot still checks current decision clarity." },
    snap_4: { 0: "Clear understanding is a strength; the brief can help you keep it documented.", 1: "Somewhat clear often means some gaps; the snapshot highlights where they might be.", 2: INSIGHT_GENERIC_EN },
    snap_5: { 0: INSIGHT_GENERIC_EN, 1: "Being involved when needed works better with a clear priority list — the assessment can provide that." },
    snap_6: { 0: "Reactive is fine; the snapshot can still show where a bit of planning would reduce stress.", 1: "Planning ahead pairs well with documented evidence — the next step supports that." }
  };

  const SNAPSHOT = [
    {
      id: "snap_1",
      title: "When electrical work is recommended, what usually happens?",
      options: [
        "I approve it quickly but later wonder if it was really necessary",
        "I delay the decision because I’m unsure",
        "I’m generally confident making these decisions"
      ]
    },
    {
      id: "snap_2",
      title: "Have you ever received different opinions or quotes for the same issue?",
      options: [
        "Yes, and it made the decision harder",
        "Yes, but I knew what to choose",
        "No"
      ]
    },
    {
      id: "snap_3",
      title: "After electrical work is completed, have you ever worried about safety or quality?",
      options: ["Yes", "No"]
    },
    {
      id: "snap_4",
      title: "Do you feel you have a clear understanding of your property’s electrical condition as a whole?",
      options: ["Yes", "Somewhat", "Not really"]
    },
    {
      id: "snap_5",
      title: "How much time do you want to spend managing electrical matters?",
      options: ["As little as possible", "I’m okay being involved when needed"]
    },
    {
      id: "snap_6",
      title: "Which statement feels closer to you?",
      options: ["I prefer reacting when issues arise", "I prefer planning ahead, even if nothing is urgent"]
    }
  ];

  // -----------------------------
  // State
  // -----------------------------
  const state = {
    stage: 1,     // 1 eligibility, 2 snapshot, 3 result, 4 contact form, 5 success
    index: 0,     // question index within stage; intro uses -1
    answers: {},
    lead: null,
    _tracked: {}  // Track events that have been sent to avoid duplicates
  };

  // -----------------------------
  // Analytics / Tracking
  // -----------------------------
  
  /**
   * Safe tracking function for GA4 events
   * Silently fails if gtag is not available (e.g., ad blockers, dev environment)
   * @param {string} eventName - Event name to track
   * @param {object} params - Optional event parameters
   */
  function track(eventName, params = {}){
    try {
      if (typeof gtag !== 'undefined' && gtag) {
        gtag('event', eventName, params);
      }
    } catch (e) {
      // Silently ignore tracking errors (e.g., ad blockers, network issues)
    }
  }

  // -----------------------------
  // Helpers
  // -----------------------------
  function $(id){ return document.getElementById(id); }

  function setActiveStepTag(step){
    $("tag0").classList.toggle("active", step === 0);
    $("tag1").classList.toggle("active", step === 1);
    $("tag2").classList.toggle("active", step === 2);
    $("tag3").classList.toggle("active", step === 3);
    $("tag4").classList.toggle("active", step === 4 || step === 5);
    $("statusPill").textContent = `Step ${step} of 5`;
  }

  function computeProgress(){
    const total = ELIGIBILITY.length + SNAPSHOT.length;
    let done = 0;
    for (const q of ELIGIBILITY) if (state.answers[q.id] !== undefined) done++;
    for (const q of SNAPSHOT) if (state.answers[q.id] !== undefined) done++;
    const pct = Math.round((done / total) * 100);
    $("bar").style.width = `${pct}%`;
    $("progressText").textContent = `${pct}% complete`;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }


  // Modal helpers
  function updateReferralLinkFromForm(){
    const inp = document.getElementById("referralLinkInput");
    if (!inp) return;
    const rid = generateReferralID();
    const base = window.location.origin + window.location.pathname;
    inp.value = base + "?ref=" + rid;
  }

  function openCallModal(){
    const m = $("callModal");
    if (!m) return;
    m.classList.add("open");
    m.style.display = "flex";
    document.body.style.overflow = "hidden";
    prefillQuickCallFromLead();
    track("quick_call_open");
    var qcName = document.getElementById("qc_name");
    var qcPhone = document.getElementById("qc_phone");
    if (qcName && !qcName._refListener) { qcName._refListener = true; qcName.addEventListener("input", updateReferralLinkFromForm); qcName.addEventListener("change", updateReferralLinkFromForm); }
    if (qcPhone && !qcPhone._refListener) { qcPhone._refListener = true; qcPhone.addEventListener("input", updateReferralLinkFromForm); qcPhone.addEventListener("change", updateReferralLinkFromForm); }
  }
  function closeCallModal(){
    const m = $("callModal");
    if (!m) return;
    m.classList.remove("open");
    // Force hide
    m.style.display = "none";
    document.body.style.overflow = "";
  }


  function formatDateISOToReadable(iso){
    if(!iso) return "";
    const parts = iso.split("-");
    if(parts.length !== 3) return iso;
    const [y,m,d] = parts;
    return `${d}/${m}/${y}`;
  }

  function buildQuickCallMailto(payload){
    const summary = buildAnswerSummary();
    const subject = encodeURIComponent("Request a quick suitability call");
    const body = encodeURIComponent(
      `Hello,

` +
      `I’ve just completed the Electrical Risk Snapshot and would like to request a quick suitability call.

` +
      `My details are below:

` +
      `Name: ${payload.name}
` +
      `Phone: ${payload.phone}
` +
      `Email: ${payload.email}
` +
      (payload.suburb ? `Property area: ${payload.suburb}
` : "") +
      `
Preferred call time (Adelaide):
` +
      `Date: ${payload.dateReadable}
` +
      `Window: ${payload.window}

` +
      (payload.notes ? `Notes:
${payload.notes}

` : "") +
      `Snapshot summary (for reference):
` +
      `${summary}

` +
      `Kind regards,
` +
      `${payload.name}
`
    );
    return `mailto:${CONTACT_EMAIL}?subject=${subject}&body=${body}`;
  }

  function prefillQuickCallFromLead(){
    try{
      if(!state || !state.lead) return;
      const n = $("qc_name"), p=$("qc_phone"), e=$("qc_email");
      if(n && !n.value) n.value = state.lead.name || "";
      if(p && !p.value) p.value = state.lead.phone || "";
      if(e && !e.value) e.value = state.lead.email || "";
    }catch(err){}
  }



  function isEligible(){
    // Updated rule:
    // - If user has 0 properties => not suitable.
    // - Allow 1/2/3+ to continue if open to pay AND prefers help (delegate or low involvement).
    const q1 = state.answers["elig_q1"];
    const q2 = state.answers["elig_q2"];
    const q3 = state.answers["elig_q3"];
    const q4 = state.answers["elig_q4"];

    const hasProperty = (q1 !== "0");
    const openToPay = (q4 === "Yes");
    const prefersHelp = (q2 === "Prefer to delegate or rely on independent advice" || q3 === "I prefer things to run without my involvement");

    return Boolean(hasProperty && openToPay && prefersHelp);
  }

  function snapshotUncertaintyFlag(){
    return computeSnapshotScore() >= 2;
  }

  function computeSnapshotScore(){
    const a1 = state.answers["snap_1"];
    const a2 = state.answers["snap_2"];
    const a4 = state.answers["snap_4"];
    const a5 = state.answers["snap_5"];
    const a6 = state.answers["snap_6"];
    let score = 0;
    if (a1 && a1.indexOf("generally confident") === -1) score += 1;
    if (a2 && a2 !== "No") score += 1;
    if (a4 && a4 !== "Yes") score += 1;
    if (a5 && a5 === "As little as possible") score += 1;
    if (a6 && a6 === "I prefer planning ahead, even if nothing is urgent") score += 1;
    return score;
  }

  function getRiskLevel(){
    const s = computeSnapshotScore();
    if (s <= 1) return "green";
    if (s <= 3) return "yellow";
    return "red";
  }

  function generateReferralID(){
    const nameEl = document.getElementById("qc_name") || document.getElementById("name");
    const phoneEl = document.getElementById("qc_phone") || document.getElementById("phone");
    const name = (state.lead && state.lead.name) || (nameEl && nameEl.value) || "";
    const phone = (state.lead && state.lead.phone) || (phoneEl && phoneEl.value) || "";
    if (name && phone) {
      const initial = name.trim().charAt(0).toUpperCase();
      const last4 = phone.replace(/\D/g, "").slice(-4) || "0000";
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return initial + last4 + random;
    }
    return "REF" + Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  function getReferralLink(){
    const rid = generateReferralID();
    return window.location.origin + window.location.pathname + "?ref=" + rid;
  }

  function showToast(message){
    const existing = document.querySelector(".referral-toast");
    if (existing) existing.remove();
    const toast = document.createElement("div");
    toast.className = "referral-toast";
    toast.textContent = message;
    toast.style.cssText = "position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:99999;animation:toastSlideIn .3s ease;";
    document.body.appendChild(toast);
    setTimeout(function(){
      toast.style.animation = "toastSlideOut .3s ease forwards";
      setTimeout(function(){ toast.remove(); }, 300);
    }, 3000);
  }

  function copyReferralLink(){
    const input = document.getElementById("referralLinkInput");
    if (!input) return;
    input.select();
    input.setSelectionRange(0, 99999);
    try {
      navigator.clipboard.writeText(input.value);
      showToast("Link copied! Share it with your friends");
    } catch (e) {
      document.execCommand("copy");
      showToast("Link copied! Share it with your friends");
    }
    track("referral_link_copied", { user_id: (input.value.split("ref=")[1] || "").split("&")[0] || "", risk_level: getRiskLevel() });
  }

  function shareViaEmail(){
    const input = document.getElementById("referralLinkInput");
    const link = input ? input.value : getReferralLink();
    const subject = encodeURIComponent("Free Electrical Risk Check for Your Investment Property");
    const body = encodeURIComponent(
      "Hi there,\n\n" +
      "I just used Better Home's free Electrical Risk Snapshot tool - it only takes 3 minutes to find out if your investment property has any electrical safety issues.\n\n" +
      "You should try it too: " + link + "\n\n" +
      "P.S. When you complete it, we both get $30 OFF on professional electrical checks!\n\n" +
      "Cheers"
    );
    window.open("mailto:?subject=" + subject + "&body=" + body);
    track("share_button_clicked", { platform: "email", user_id: generateReferralID() });
  }

  function shareViaWhatsApp(){
    const input = document.getElementById("referralLinkInput");
    const link = input ? input.value : getReferralLink();
    const text = encodeURIComponent(
      "Just did a free electrical safety check for my investment property - found out I have some issues!\n\n" +
      "You should check yours too (3 mins): " + link + "\n\n" +
      "Complete it and we both get $30 OFF"
    );
    window.open("https://wa.me/?text=" + text);
    track("share_button_clicked", { platform: "whatsapp", user_id: generateReferralID() });
  }

  function shareViaFacebook(){
    const input = document.getElementById("referralLinkInput");
    const link = input ? input.value : getReferralLink();
    window.open("https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(link));
    track("share_button_clicked", { platform: "facebook", user_id: generateReferralID() });
  }

  function bookNow(){
    track("conversion_action", { action_type: "book_now", user_id: generateReferralID(), risk_level: getRiskLevel() });
    openCallModal();
  }

  function callNow(){
    track("conversion_action", { action_type: "call_now", user_id: generateReferralID(), risk_level: getRiskLevel() });
    openCallModal();
  }

  function buildAnswerSummary(){
    const lines = [];
    for (const q of ELIGIBILITY){
      const a = state.answers[q.id];
      if (a !== undefined) lines.push(`[Eligibility] ${q.title} -> ${a}`);
    }
    for (const q of SNAPSHOT){
      const a = state.answers[q.id];
      if (a !== undefined) lines.push(`[Snapshot] ${q.title} -> ${a}`);
    }
    return lines.join("\n");
  }

  // -----------------------------
  // UI blocks
  // -----------------------------
  function renderStep0(){
    setActiveStepTag(0);
    $("timeText").textContent = "~5 minutes total";
    const el = document.createElement("div");
    el.innerHTML = `
      <h2>Before you spend on electrical work, take 3 minutes to check your “Decision Clarity”</h2>
      <p class="sub">This snapshot won’t tell you “what is broken”. It helps you answer a more important question: when you need to make an electrical safety decision, are you deciding with clear information or guesswork?</p>
      <p class="small">This is not a test of electrical knowledge — there are no right or wrong answers. When you finish, you’ll receive a personalised “Electrical Decision Confidence Brief” and clear next-step guidance.</p>
      <div class="accordion" id="faqAccordion">
        <div class="accordion-toggle" id="faqToggle">I’d like to learn more <span id="faqChevron">▼</span></div>
        <div class="accordion-content" id="faqContent">
          <p><strong>Is this a sales pitch for repairs?</strong> No. This snapshot is decision-focused and does not provide repair quotes.</p>
          <p><strong>Do I need anything prepared?</strong> No — just answer based on your real situation.</p>
        </div>
      </div>
      <div class="hr"></div>
      <div class="nav">
        <span></span>
        <button class="primary" id="startBtn0">Start</button>
      </div>
    `;
    el.querySelector("#startBtn0").addEventListener("click", () => {
      track('snapshot_start');
      state.stage = 1;
      state.index = -1;
      render();
    });
    const toggle = el.querySelector("#faqToggle");
    if (toggle) toggle.addEventListener("click", () => {
      const c = el.querySelector("#faqContent");
      if (c) { c.classList.toggle("open"); toggle.setAttribute("aria-expanded", c.classList.contains("open")); }
    });
    return el;
  }

  function renderIntroEligibility(){
    setActiveStepTag(1);
    $("timeText").textContent = "~5 minutes total";
    const el = document.createElement("div");
    el.innerHTML = `
      <h2>Is this service right for you?</h2>
      <p class="sub"><strong>60-second eligibility check</strong> — no technical knowledge required</p>
      <p class="small">
        This service is designed for a <strong>specific type of property owner</strong>.<br/>
        Before we go any further, this quick check helps confirm whether it’s relevant for your situation.<br/>
        <em>There are no right or wrong answers.</em>
      </p>
      <div class="hr"></div>
    `;
    return el;
  }

  function renderSnapshotIntro(){
    setActiveStepTag(2);
    $("timeText").textContent = "~3–4 minutes";
    const el = document.createElement("div");
    el.innerHTML = `
      <h2>Electrical Risk Snapshot</h2>
      <p class="sub">A short, guided self-check</p>
      <div class="resultBox">
        <div class="small">
          <div><strong>This is not an inspection.</strong></div>
          <div><strong>This does not result in a quote.</strong></div>
          <div style="margin-top:10px">
            The snapshot is a short, guided self-check designed to identify whether uncertainty may exist
            around electrical safety, planning, or decision-making.
          </div>
          <div style="margin-top:10px">
            Most people complete this in <strong>3–4 minutes</strong>.
          </div>
        </div>
      </div>
      <div class="hr"></div>
    `;
    return el;
  }

  function renderQuestion(q){
    const selected = state.answers[q.id];

    const container = document.createElement("div");
    container.innerHTML = `
      <h2>${state.stage === 1 ? "Quick Eligibility Check" : "Electrical Risk Snapshot"}</h2>
      <p class="sub">${state.stage === 1 ? "One minute. No technical knowledge required." : "One question per screen. Fast and simple."}</p>
      <p class="qTitle">${escapeHtml(q.title)}</p>
      <div class="choices" role="radiogroup" aria-label="${escapeHtml(q.title)}"></div>
      <div class="insight" id="insightBox" aria-live="polite"></div>
      <div class="hint">There are no right or wrong answers.</div>
      <div class="nav">
        <button class="ghost" id="backBtn">← Back</button>
        <button class="primary" id="nextBtn" disabled>Next →</button>
      </div>
    `;

    const choices = container.querySelector(".choices");
    const insightBox = container.querySelector("#insightBox");
    const updateInsight = (optIndex) => {
      const map = INSIGHT_MAP_EN[q.id];
      const text = (map && map[optIndex] !== undefined) ? map[optIndex] : INSIGHT_GENERIC_EN;
      if (insightBox) { insightBox.textContent = text ? "\u200B" + text : ""; }
    };

    q.options.forEach((opt, i) => {
      const id = `${q.id}_${i}`;
      const label = document.createElement("label");
      label.className = "choice";
      label.innerHTML = `
        <input type="radio" name="${q.id}" id="${id}" value="${escapeHtml(opt)}" ${selected === opt ? "checked" : ""}/>
        <div>${escapeHtml(opt)}</div>
      `;
      label.querySelector("input").addEventListener("change", (e) => {
        state.answers[q.id] = e.target.value;
        const idx = q.options.indexOf(e.target.value);
        updateInsight(idx >= 0 ? idx : 0);
        container.querySelector("#nextBtn").disabled = false;
        computeProgress();
      });
      choices.appendChild(label);
    });

    if (selected !== undefined) {
      container.querySelector("#nextBtn").disabled = false;
      const idx = q.options.indexOf(selected);
      updateInsight(idx >= 0 ? idx : 0);
    }

    container.querySelector("#backBtn").addEventListener("click", () => goBack());
    container.querySelector("#nextBtn").addEventListener("click", () => goNext());

    return container;
  }

  function renderEligibilityEnd(){
    setActiveStepTag(1);
    $("timeText").textContent = "~5 minutes total";
    const eligible = isEligible();
    
    // Track eligibility completion (only once, avoid duplicate events on re-render)
    const trackKey = 'eligibility_complete';
    if (!state._tracked[trackKey]) {
      track('eligibility_complete', { eligible: eligible ? 'yes' : 'no' });
      state._tracked[trackKey] = true;
    }
    
    const el = document.createElement("div");

    if (!eligible){
      el.innerHTML = `
        <h2>This service may not be the best fit right now</h2>
        <p class="sub">No further action required.</p>
        <div class="resultBox">
          <span class="badge no">Not suitable (for now)</span>
          <div class="small">
            Based on your responses, this service is likely more than you need at this stage.<br/><br/>
            If you’re primarily looking to carry out electrical work or quick repairs,
            a standard electrical contractor may be more suitable.
          </div>
        </div>
        <div class="ctaRow">
          <button class="primary" id="restartBtn">Restart</button>
          <a class="cta" href="mailto:${CONTACT_EMAIL}">Contact us</a>
        </div>
      `;
      el.querySelector("#restartBtn").addEventListener("click", () => restart());
      return el;
    }

    el.innerHTML = `
      <h2>You may find the next step useful</h2>
      <p class="sub">The next step is a short Electrical Risk Snapshot.</p>
      <div class="resultBox">
        <span class="badge ok">Suitable</span>
        <div class="small">
          This is not an inspection and does not result in a quote.<br/><br/>
          It’s designed to help you understand whether there may be areas where decisions are currently made
          without full visibility.
        </div>
      </div>
      <div class="ctaRow">
        <button class="primary" id="startSnapshotBtn">Start Risk Snapshot (3–4 minutes) →</button>
        <button class="ghost" id="restartBtn">Restart</button>
      </div>
    `;
    el.querySelector("#startSnapshotBtn").addEventListener("click", () => {
      state.stage = 2;
      state.index = -1;
      render();
    });
    el.querySelector("#restartBtn").addEventListener("click", () => restart());
    return el;
  }

  function renderShareSection(){
    const level = getRiskLevel();
    const link = getReferralLink();
    const shareLinkHtml = '<div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 12px; padding: 15px; margin-bottom: 20px;"><p style="color: white; font-size: 14px; margin: 0 0 8px 0;">Your Referral Link:</p><div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;"><input type="text" id="referralLinkInput" value="' + link + '" readonly style="flex: 1; min-width: 180px; padding: 10px; border-radius: 8px; border: none; font-size: 14px;" /><button onclick="copyReferralLink()" style="padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Copy</button></div></div>';
    const shareLinkHtmlPlain = '<div style="background: #f5f5f5; border-radius: 12px; padding: 15px; margin-bottom: 20px;"><p style="color: #333; font-size: 14px; margin: 0 0 8px 0;">Your Referral Link:</p><div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;"><input type="text" id="referralLinkInput" value="' + link + '" readonly style="flex: 1; min-width: 180px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; background: white;" /><button onclick="copyReferralLink()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Copy</button></div></div>';
    const shareBtns = '<div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;"><button onclick="shareViaEmail()" class="share-btn">Share via Email</button><button onclick="shareViaWhatsApp()" class="share-btn">Share on WhatsApp</button><button onclick="shareViaFacebook()" class="share-btn">Share on Facebook</button></div>';
    if (level === "green") {
      return '<div class="share-section" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; text-align: center;"><h3 style="color: white; margin: 0 0 10px 0;">Share this snapshot</h3><p style="color: rgba(255,255,255,0.9); margin: 0 0 20px 0;">You may share it with other property owners for reference.</p>' + shareLinkHtml + shareBtns + '<p style="color: rgba(255,255,255,0.8); font-size: 13px; margin: 15px 0 0 0;">When friends complete the snapshot, we\'ll send a thank-you discount code by email.</p></div>';
    }
    if (level === "yellow") {
      return '<div class="share-section" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px; text-align: center;"><h3 style="color: white; margin: 0 0 10px 0;">Share this snapshot</h3><p style="color: rgba(255,255,255,0.9); margin: 0 0 20px 0;">You may share it with other property owners for reference.</p>' + shareLinkHtml + shareBtns + '<p style="color: rgba(255,255,255,0.8); font-size: 13px; margin: 15px 0 0 0;">When friends complete the snapshot, we\'ll send a thank-you discount code by email.</p></div>';
    }
    return '<div class="share-section" style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 16px; text-align: center;"><h3 style="color: #333; margin: 0 0 10px 0;">Share this snapshot</h3><p style="color: #666; margin: 0 0 20px 0;">You may share it with other property owners for reference.</p>' + shareLinkHtmlPlain + shareBtns + '<p style="color: #888; font-size: 13px; margin: 15px 0 0 0;">When friends complete the snapshot, we\'ll send a thank-you discount code by email.</p></div>';
  }

  function renderFinal(){
    setActiveStepTag(3);
    $("timeText").textContent = "";
    const uncertain = snapshotUncertaintyFlag();
    const level = getRiskLevel();
    
    // Track snapshot completion (only once, avoid duplicate events on re-render)
    const trackKey = 'snapshot_complete';
    if (!state._tracked[trackKey]) {
      track('snapshot_complete', { uncertainty: uncertain ? 'yes' : 'no', risk_level: level, referred_by: localStorage.getItem('referredBy') || 'direct' });
      state._tracked[trackKey] = true;
    }

    const badgeText = level === "green" ? "Low decision uncertainty" : level === "yellow" ? "Some decision uncertainty identified" : "Higher decision uncertainty — further clarification recommended";
    const mainText = level === "green" ? "Based on your responses, you generally feel confident making electrical-related decisions." : level === "yellow" ? "Based on your responses, there may be areas where electrical decisions are made with incomplete information or limited confidence." : "Based on your responses, you may frequently face uncertainty, hesitation, or the need for additional reassurance when making electrical decisions.";
    const hintText = level === "green" ? "This does not mean the property has no risk. It simply suggests that your decisions are currently less influenced by uncertainty. If you would like to turn future electrical spending into a clearer 1–5 year planning view, an independent assessment may still be valuable." : level === "yellow" ? "This does not mean there is a confirmed problem. It simply indicates that in situations such as repair recommendations or tenant concerns, you may benefit from clearer evidence and prioritisation." : "This does not mean a safety fault has been identified. It suggests that when decisions arise under pressure — such as tenant complaints, tripping circuits, or urgent repairs — the absence of a structured framework may increase financial or responsibility risk. The purpose of an independent assessment is to provide documented evidence and a planning pathway before problems escalate.";

    const redResultBox = level === "red" ? `<div class="resultBox" style="margin-bottom:20px; padding:24px; background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); border-radius: 16px; color: white; box-shadow: 0 0 30px rgba(255,8,68,0.2);"><span class="badge" style="background: rgba(255,255,255,0.3); color: white;">${badgeText}</span><div class="small" style="color: rgba(255,255,255,0.95); margin-top:12px;">${mainText}<br/><br/>${hintText}</div></div>` : "";

    const el = document.createElement("div");
    el.innerHTML = `
      <h2>Your "Electrical Decision Confidence Brief" is ready</h2>

      ${redResultBox}

      <div class="resultBox" style="${level === "red" ? "display:none" : ""}">
        <span class="badge ${level === "green" ? "" : "ok"}">${badgeText}</span>
        <div class="small">
          ${mainText}<br/><br/>
          ${hintText}
        </div>
        <div class="small" style="margin-top:14px; color: var(--muted);">
          <strong>What the next step can provide:</strong>
          <ul style="margin:10px 0 0 18px;">
            <li>Objective evidence of electrical condition (photos &amp; data)</li>
            <li>A 1–3 year priority and budget roadmap (planning only)</li>
            <li>A professional report you can use with tenants, property managers, or insurers</li>
          </ul>
          <em>Most clients use this as clarity first — not to approve work immediately.</em>
        </div>
      </div>

      <div class="resultBox" style="${level !== "red" ? "display:none" : ""}">
        <div class="small" style="margin-top:0; color: var(--muted);">
          <strong>What the next step can provide:</strong>
          <ul style="margin:10px 0 0 18px;">
            <li>Objective evidence of electrical condition (photos &amp; data)</li>
            <li>A 1–3 year priority and budget roadmap (planning only)</li>
            <li>A professional report you can use with tenants, property managers, or insurers</li>
          </ul>
          <em>Most clients use this as clarity first — not to approve work immediately.</em>
        </div>
      </div>

      <div class="ctaRow">
        <button class="cta primary" id="bookBtn" type="button">Book a free 15-min call to review your snapshot</button>
        <button class="cta ghost" id="learnMoreBtn" type="button">Learn more</button>
        <button class="cta ghost" id="leadFormBtn" type="button">Request full assessment (no call)</button>
        <a class="cta ghost" id="pdfDownloadLinkEn" href="investment%20property%20check%20guide.pdf" download target="_blank" rel="noopener" style="display:none">Download: Investment Property Electrical Risk Check Guide (PDF)</a>
        <button class="cta ghost" id="pdfBtn" type="button">Send check guide to my email (with thank-you note)</button>
        <button class="ghost" id="restartBtn">Restart</button>
      </div>

      ${renderShareSection()}

      <div class="small" style="margin-top:10px;">
        Fixed-fee • No repair quotes • No obligation to proceed
      </div>

      <div class="footerNote">
        If you would like to speak with someone before booking, please
        <a href="mailto:${CONTACT_EMAIL}" style="color:var(--accent);">contact us</a>.
      </div>
    `;

    el.querySelector("#restartBtn").addEventListener("click", () => restart());
    el.querySelector("#bookBtn").addEventListener("click", () => { track("conversion_action", { action_type: "book_now", user_id: generateReferralID(), risk_level: getRiskLevel() }); openCallModal(); });
    (function attachReferralLinkUpdate(){
      const qcName = document.getElementById("qc_name");
      const qcPhone = document.getElementById("qc_phone");
      const upd = function(){
        const inp = document.getElementById("referralLinkInput");
        if (inp) { const rid = generateReferralID(); inp.value = window.location.origin + window.location.pathname + "?ref=" + rid; }
      };
      if (qcName) qcName.addEventListener("input", upd);
      if (qcPhone) qcPhone.addEventListener("input", upd);
    })();
    const leadFormBtn = el.querySelector("#leadFormBtn");
    if (leadFormBtn) leadFormBtn.addEventListener("click", () => {
      const trackKey = 'lead_form_view';
      if (!state._tracked[trackKey]) {
        track('lead_form_view');
        state._tracked[trackKey] = true;
      }
      state.stage = 4;
      state.index = 0;
      render();
    });
    const pdfBtn = el.querySelector("#pdfBtn");
    if (pdfBtn) pdfBtn.addEventListener("click", () => openPdfModal());
    const learnMoreBtn = el.querySelector("#learnMoreBtn");
    if (learnMoreBtn) learnMoreBtn.addEventListener("click", () => openLearnMoreModal());
    return el;
  }

  function openLearnMoreModal(){
    const m = $("learnMoreModal");
    if (!m) return;
    m.classList.add("open");
    m.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
  function closeLearnMoreModal(){
    const m = $("learnMoreModal");
    if (!m) return;
    m.classList.remove("open");
    m.style.display = "none";
    document.body.style.overflow = "";
  }

  function openPdfModal(){
    const m = $("pdfModal");
    if (!m) return;
    m.classList.add("open");
    m.style.display = "flex";
    document.body.style.overflow = "hidden";
    const inp = $("pdfEmail");
    if (inp) { inp.value = (state.lead && state.lead.email) ? state.lead.email : ""; inp.focus(); }
    $("pdfErr").style.display = "none";
  }
  function closePdfModal(){
    const m = $("pdfModal");
    if (!m) return;
    m.classList.remove("open");
    m.style.display = "none";
    document.body.style.overflow = "";
  }

  function renderLeadForm(){
    setActiveStepTag(4);
    $("timeText").textContent = "1 minute";

    const el = document.createElement("div");
    el.innerHTML = `
      <h2>Book an independent assessment</h2>
      <p class="sub">Leave your details and our advisor will contact you shortly.</p>


      <div class="small" style="margin-top:-6px; margin-bottom:10px;">
        Prefer a short call first? Go back and click <strong>Book a free 15-min call</strong> on the previous page.
      </div>

      <div class="resultBox">
        <div class="small">
          <strong>What happens next?</strong>
          <ul style="margin:10px 0 0 18px; color: var(--muted);">
            <li>We review your snapshot</li>
            <li>We contact you to confirm suitability</li>
            <li>We schedule a convenient on-site assessment time</li>
          </ul>
        </div>
      </div>

      <div class="hr"></div>

      <form id="leadForm" novalidate>
        <p class="qTitle">Your contact details</p>

        <div style="display:grid; gap:10px; max-width:520px;">
          <div>
            <label class="small" for="name">Full name *</label><br/>
            <input id="name" name="name" type="text" required />
          </div>

          <div>
            <label class="small" for="phone">Phone *</label><br/>
            <input id="phone" name="phone" type="tel" required placeholder="e.g. 04xx xxx xxx" />
          </div>

          <div>
            <label class="small" for="email">Email *</label><br/>
            <input id="email" name="email" type="email" required placeholder="name@email.com" />
          </div>

          <div>
            <label class="small" for="notes">Anything you’d like us to know? (optional)</label><br/>
            <textarea id="notes" name="notes" rows="3"></textarea>
          </div>

          <div class="err" id="err">Please complete all required fields with a valid email.</div>

          <div class="nav" style="max-width:520px;">
            <button type="button" class="ghost" id="backBtn">← Back</button>
            <button type="submit" class="primary" id="submitBtn">Submit →</button>
          </div>
        </div>
      </form>

      <div class="footerNote">
        By submitting, you agree we may contact you about this assessment request.
      </div>
    `;

    el.querySelector("#backBtn").addEventListener("click", () => {
      state.stage = 3;
      state.index = 0;
      render();
    });

    el.querySelector("#leadForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = el.querySelector("#name").value.trim();
      const phone = el.querySelector("#phone").value.trim();
      const email = el.querySelector("#email").value.trim();
      const notes = el.querySelector("#notes").value.trim();

      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!name || !phone || !emailOk){
        el.querySelector("#err").style.display = "block";
        return;
      }
      el.querySelector("#err").style.display = "none";

      // Prepare summary for your inbox (offline-friendly: opens user's mail app)
      const summary = buildAnswerSummary();
      const subject = encodeURIComponent("Request for Independent Electrical Risk Assessment");
      const body = encodeURIComponent(
        `Hello,

` +
        `I’ve just completed the Electrical Risk Snapshot on your website and would like to request an independent electrical assessment.

` +
        `My details are below:

` +
        `Name: ${name}
` +
        `Phone: ${phone}
` +
        `Email: ${email}

` +
        `Property type:
` +
        `• Investment property

` +
        `Reason for enquiry:
` +
        `• I would like clearer visibility and independent advice before making future electrical decisions.

` +
        (notes ? `Additional notes:
• ${notes}

` : "") +
        `Snapshot summary (for reference):
` +
        `${summary}

` +
        `Please let me know the next steps.

` +
        `Kind regards,
` +
        `${name}
`
      );
// Store lead locally for the success screen
      state.lead = { name, phone, email };

      const submitBtn = el.querySelector("#submitBtn");
      const origText = submitBtn ? submitBtn.textContent : "";
      if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = "Sending…"; }
      try {
        const res = await fetch("/.netlify/functions/send-booking", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "lead", lang: "en", name, phone, email, notes, summary, referredBy: localStorage.getItem("referredBy") || "direct" }),
        });
        const data = await res.json().catch(() => ({}));
        state.lead = { name, phone, email };
        track('lead_submit', { method: 'api' });
        state.stage = 5;
        state.index = 0;
        render();
        if (!res.ok) alert(data.error || "Request could not be sent. Please try again or email us directly.");
      } catch (err) {
        alert("Network error. Please try again or email us at " + CONTACT_EMAIL);
      }
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = origText; }
    });

    return el;
  }

  function renderSuccess(){
    setActiveStepTag(4);
    $("timeText").textContent = "";

    const name = (state.lead && state.lead.name) ? state.lead.name : "there";
    const el = document.createElement("div");

    el.innerHTML = `
      <h2>Thank you, ${escapeHtml(name)}.</h2>
      <p class="sub">Your request has been received.</p>

      <div class="resultBox">
        <span class="badge ok">Request received</span>
        <div class="small">
          We've received your request for an independent assessment. Our advisor will contact you shortly to confirm suitability and arrange a convenient time.
        </div>
      </div>

      <div class="ctaRow">
        <button class="ghost" id="restartBtn">Start again</button>
        <a class="cta" href="mailto:${CONTACT_EMAIL}">Contact us</a>
      </div>

      <div class="small" style="margin-top:10px;">
        Fixed-fee • No repair quotes • No obligation to proceed
      </div>

      <div class="footerNote">
        If you have any questions, email us at
        <a href="mailto:${CONTACT_EMAIL}" style="color:var(--accent);">${CONTACT_EMAIL}</a>.
      </div>
    `;

    el.querySelector("#restartBtn").addEventListener("click", () => restart());
    return el;
  }


  // -----------------------------
  // Navigation Logic
  // -----------------------------
  function goBack(){
    if (state.stage === 0) return;
    if (state.stage === 1){
      if (state.index === -1){ state.stage = 0; state.index = 0; render(); return; }
      state.index -= 1;
      render();
      return;
    }
    if (state.stage === 2){
      if (state.index === -1){
        state.stage = 1;
        state.index = ELIGIBILITY.length;
        render();
        return;
      }
      state.index -= 1;
      render();
      return;
    }
    if (state.stage === 3){
      state.stage = 2;
      state.index = SNAPSHOT.length - 1;
      render();
      return;
    }
    if (state.stage === 4){
      state.stage = 3;
      state.index = 0;
      render();
      return;
    }
  }

  function goNext(){
    if (state.stage === 1){
      if (state.index < ELIGIBILITY.length - 1){
        state.index += 1;
      } else {
        state.index = ELIGIBILITY.length;
      }
      render();
      return;
    }
    if (state.stage === 2){
      if (state.index < SNAPSHOT.length - 1){
        state.index += 1;
        render();
      } else {
        state.stage = 3;
        state.index = 0;
        render();
      }
      return;
    }
  }

  function restart(){
    state.stage = 0;
    state.index = 0;
    state.answers = {};
    state.lead = null;
    state.draftMailto = null;
    state._tracked = {};
    computeProgress();
    render();
  }

  // -----------------------------
  // Render
  // -----------------------------
  function render(){
    const app = $("app");
    app.innerHTML = "";
    computeProgress();

    if (state.stage === 0){
      app.appendChild(renderStep0());
      return;
    }

    if (state.stage === 1){
      setActiveStepTag(1);
      if (state.index === -1){
        app.appendChild(renderIntroEligibility());
        const start = document.createElement("div");
        start.innerHTML = `
          <div class="nav">
            <span></span>
            <button class="primary" id="startBtn">Start (60 seconds) →</button>
          </div>
        `;
        start.querySelector("#startBtn").addEventListener("click", () => {
          track('snapshot_start');
          state.index = 0;
          render();
        });
        app.appendChild(start);
        return;
      }

      if (state.index === ELIGIBILITY.length){
        app.appendChild(renderEligibilityEnd());
        return;
      }

      app.appendChild(renderQuestion(ELIGIBILITY[state.index]));
      return;
    }

    if (state.stage === 2){
      setActiveStepTag(2);

      if (state.index === -1){
        app.appendChild(renderSnapshotIntro());
        const nav = document.createElement("div");
        nav.innerHTML = `
          <div class="nav">
            <button class="ghost" id="backBtn">← Back</button>
            <button class="primary" id="startSnapBtn">Start Snapshot →</button>
          </div>
        `;
        nav.querySelector("#backBtn").addEventListener("click", () => goBack());
        nav.querySelector("#startSnapBtn").addEventListener("click", () => {
          state.index = 0;
          render();
        });
        app.appendChild(nav);
        return;
      }

      app.appendChild(renderQuestion(SNAPSHOT[state.index]));
      return;
    }

    if (state.stage === 3){
      app.appendChild(renderFinal());
      return;
    }

    if (state.stage === 4){
      app.appendChild(renderLeadForm());
      return;
    }

    if (state.stage === 5){
      app.appendChild(renderSuccess());
      return;
    }
  }

  
  // Global modal listeners
  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "closeCallModal") closeCallModal();
    if (e.target && e.target.id === "closeCallModal2") closeCallModal();
    if (e.target && e.target.id === "callModal") closeCallModal();
    if (e.target && e.target.id === "closeLearnMoreModal") closeLearnMoreModal();
    if (e.target && e.target.id === "learnMoreModal") closeLearnMoreModal();
    if (e.target && e.target.id === "closePdfModal") closePdfModal();
    if (e.target && e.target.id === "pdfCancelBtn") closePdfModal();
    if (e.target && e.target.id === "pdfModal") closePdfModal();
  });
  document.addEventListener("click", async (e) => {
    if (e.target && e.target.id === "pdfSendBtn") {
      const inp = $("pdfEmail");
      const err = $("pdfErr");
      const email = inp && inp.value ? inp.value.trim() : "";
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!ok) { if (err) err.style.display = "block"; return; }
      if (err) err.style.display = "none";
      const btn = e.target;
      const origText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Sending…";
      try {
        const res = await fetch("/.netlify/functions/send-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, lang: "en" }),
        });
        const data = await res.json().catch(() => ({}));
        closePdfModal();
        if (res.ok && data.ok) {
          alert("Check your inbox—we've sent the guide to your email. Thanks for completing the snapshot.");
        } else {
          var link = document.getElementById("pdfDownloadLinkEn"); if (link) link.style.display = "inline-flex";
          alert(data.error || "Something went wrong. You can use the download link below to get the guide.");
        }
      } catch (err2) {
        var link = document.getElementById("pdfDownloadLinkEn"); if (link) link.style.display = "inline-flex";
        alert("Network error. You can use the download link below to get the guide.");
      }
      btn.disabled = false;
      btn.textContent = origText;
    }
  });

  // Quick call form: send via API (no mailto)
  document.addEventListener("submit", async (e) => {
    if (!e.target || e.target.id !== "quickCallForm") return;
    e.preventDefault();

    const name = $("qc_name").value.trim();
    const phone = $("qc_phone").value.trim();
    const email = $("qc_email").value.trim();
    const suburb = $("qc_suburb").value.trim();
    const date = $("qc_date").value;
    const windowSel = $("qc_window").value;
    const notes = $("qc_notes").value.trim();

    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    if(!name || !phone || !emailOk || !date || !windowSel){
      const err = $("qc_err");
      if(err) err.style.display = "block";
      return;
    }
    const err = $("qc_err");
    if(err) err.style.display = "none";

    const qcSubmit = $("qc_submit");
    const origText = qcSubmit ? qcSubmit.textContent : "";
    if (qcSubmit) { qcSubmit.disabled = true; qcSubmit.textContent = "Sending…"; }

    try {
      const res = await fetch("/.netlify/functions/send-booking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "quickcall",
          lang: "en",
          name, phone, email, suburb,
          dateReadable: formatDateISOToReadable(date),
          window: windowSel,
          notes,
          summary: buildAnswerSummary(),
          referredBy: localStorage.getItem("referredBy") || "direct",
        }),
      });
      const data = await res.json().catch(() => ({}));
      closeCallModal();
      if (res.ok && data.ok) {
        alert("Request sent. We'll contact you at your preferred time.");
      } else {
        alert(data.error || "Could not send. Please try again or email us at " + CONTACT_EMAIL);
      }
    } catch (err2) {
      alert("Network error. Please try again or email us at " + CONTACT_EMAIL);
    }
    if (qcSubmit) { qcSubmit.disabled = false; qcSubmit.textContent = origText; }
  });




  function showReferralBanner(referrerID){
    const banner = document.createElement("div");
    banner.id = "referralBanner";
    banner.innerHTML = '<div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; text-align: center; font-size: 14px;">You were referred by a friend! Complete this check and you will both get <strong>$30 OFF</strong> discount codes.</div>';
    document.body.insertBefore(banner, document.body.firstChild);
  }

  // Ensure modal hidden on load + ref param
  document.addEventListener("DOMContentLoaded", () => {
    const m = document.getElementById("callModal");
    if (m) m.style.display = "none";

    const urlParams = new URLSearchParams(window.location.search);
    const referrerID = urlParams.get("ref");
    if (referrerID) {
      try { localStorage.setItem("referredBy", referrerID); } catch (e) {}
      track("referral_visit", { referrer_id: referrerID });
      showReferralBanner(referrerID);
    }

    track("page_open", { page: "risk_snapshot", referred_by: localStorage.getItem("referredBy") || "direct" });
  });

  // Start
  restart();</script>

  <!-- Quick Call Modal -->
  <div class="modalOverlay" id="callModal" role="dialog" aria-modal="true" aria-labelledby="callModalTitle" style="display:none">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3 id="callModalTitle">Book a free 15-min call to review your snapshot</h3>
          <div class="small" style="margin-top:4px;">
            We'll do a short <strong>8–10 minute</strong> call to discuss your results and whether an independent assessment makes sense for you.
          </div>
        </div>
        <button class="modalClose" id="closeCallModal" type="button">Close ✕</button>
      </div>

      <div class="resultBox">
        <div class="small">
          <span class="miniPill">What we’ll cover</span>
          <ul style="margin:10px 0 0 18px; color: var(--muted);">
            <li>Your investment timeframe and plans (next 12–24 months)</li>
            <li>What you most want to avoid: unexpected costs, safety risk, or decision uncertainty</li>
            <li>Whether an independent assessment is actually worth it for your property</li>
          </ul>
        </div>
      </div>

      <div class="scriptGrid">
        <div class="scriptCard">
          <div class="k">A simple way to describe the service</div>
          <div class="v">
            “This isn’t a repair quote. It’s independent, documented advice that gives you clarity and a forward budget view — so future decisions are easier.”
          </div>
        </div>
        <div class="scriptCard">
          <div class="k">3 quick questions we may ask</div>
          <div class="v">
            1) “Is this a long-term hold, or are you planning changes soon?”<br/>
            2) “When electrical work is suggested, do you feel confident approving it?”<br/>
            3) “What would you like to avoid most — cost surprises, safety risk, or uncertainty?”
          </div>
        </div>
        <div class="scriptCard">
          <div class="k">What happens after the call</div>
          <div class="v">
            If it’s a fit, we’ll suggest the next step: an independent on-site assessment (fixed-fee).<br/>
            If it’s not a fit, we’ll tell you — no pressure and no obligation.
          </div>
        </div>
      </div>

      
      <div class="hr"></div>

      <form id="quickCallForm" novalidate>
        <div style="display:grid; gap:10px; max-width:560px;">
          <div>
            <label class="small" for="qc_name">Full name *</label><br/>
            <input id="qc_name" type="text" required />
          </div>
          <div>
            <label class="small" for="qc_phone">Phone *</label><br/>
            <input id="qc_phone" type="tel" required placeholder="e.g. 04xx xxx xxx" />
          </div>
          <div>
            <label class="small" for="qc_email">Email *</label><br/>
            <input id="qc_email" type="email" required placeholder="name@email.com" />
          </div>

          <div>
            <label class="small" for="qc_suburb">Property suburb or postcode (optional)</label><br/>
            <input id="qc_suburb" type="text" placeholder="e.g. Norwood 5067" />
            <div class="hint">No street address needed at this stage.</div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
              <label class="small" for="qc_date">Preferred date *</label><br/>
              <input id="qc_date" type="date" required />
            </div>
            <div>
              <label class="small" for="qc_window">Preferred time window (Adelaide) *</label><br/>
              <select id="qc_window" required style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text); outline:none;">
                <option value="" selected>Select a time window</option>
                <option>9:00–11:00</option>
                <option>11:00–13:00</option>
                <option>13:00–15:00</option>
                <option>15:00–17:00</option>
                <option>17:00–19:00</option>
              </select>
            </div>
          </div>

          <div>
            <label class="small" for="qc_notes">Anything else? (optional)</label><br/>
            <textarea id="qc_notes" rows="3" placeholder="e.g. best contact time, tenant availability, upcoming renovations"></textarea>
          </div>

          <div class="err" id="qc_err">Please complete all required fields with a valid email.</div>

          <div class="ctaRow" style="margin-top:6px;">
            <button class="cta" id="qc_submit" type="submit">Request call →</button>
            <button class="ghost" id="closeCallModal2" type="button">Not now</button>
          </div>

          <div class="small" style="margin-top:-4px;">
            We'll send your details and preferred time to our team. We'll call you in your chosen window.
          </div>
        </div>
      </form>

      <div class="footerNote">

        Tip: To request a full assessment without a call, use <strong>Request full assessment (no call)</strong> on the previous page.
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="learnMoreModal" role="dialog" aria-modal="true" aria-labelledby="learnMoreModalTitle" style="display:none">
    <div class="modal">
      <div class="modalTop">
        <h3 id="learnMoreModalTitle">What the independent assessment includes</h3>
        <button class="modalClose" id="closeLearnMoreModal" type="button">Close ✕</button>
      </div>
      <div class="resultBox" style="margin-top:0">
        <p class="small" style="margin:0 0 10px">You can think of the independent assessment as:</p>
        <ol style="margin:0 0 0 20px; padding:0; color:var(--text); font-size:17px; line-height:1.6;">
          <li style="margin-bottom:8px"><strong>On-site data collection</strong> (non-destructive)</li>
          <li style="margin-bottom:8px"><strong>Risk priorities:</strong> what to act on now, what to plan for, what to ignore</li>
          <li style="margin-bottom:8px"><strong>A 1–5 year budget outlook</strong> (CapEx planning)</li>
          <li style="margin-bottom:8px"><strong>Independent documentation</strong> you can use with tenants, property managers, or insurers</li>
        </ol>
        <p class="small" style="margin-top:14px">If you’d like to know more, we suggest booking a quick call to review your snapshot.</p>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="pdfModal" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle" style="display:none">
    <div class="modal">
      <div class="modalTop">
        <h3 id="pdfModalTitle">Send to your email</h3>
        <button class="modalClose" id="closePdfModal" type="button">Close ✕</button>
      </div>
      <div style="padding:0 0 14px">
        <p class="small" style="margin:0 0 10px">We’ll email you the check guide and a short thank-you note. Great for saving or sharing.</p>
        <label class="small" for="pdfEmail">Email</label>
        <input id="pdfEmail" type="email" placeholder="name@email.com" style="margin-top:6px" />
        <div class="err" id="pdfErr">Please enter a valid email.</div>
        <div class="ctaRow" style="margin-top:12px">
          <button class="primary" id="pdfSendBtn" type="button">Send</button>
          <button class="ghost" id="pdfCancelBtn" type="button">Cancel</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>